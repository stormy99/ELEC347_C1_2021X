#include "adc.h"
#include "dac.h"
#include <stm32f4xx.h>
#include "filter.h"
#include "usart.h"
#include <string.h>

#define ORDER 2
#define FILTER_COUNT 5

float centre_tap[5] = {0};

float xn[6] = {0};
float xnm1[5] = {0};
float xnm2[5] = {0};

float ynm1[5] = {0};
float ynm2[5] = {0};

uint8_t gain[5] = {5, 4, 4, 4, 4}; //-5n - 20

static char buf[128];

float b[FILTER_COUNT][(ORDER + 1) * 9] = { 
  //250Hz
  { 0.980358, -1.956089, 0.975993,  //-20dB
    0.983218, -1.958914, 0.975958,  //-15dB
    0.987484, -1.963127, 0.975907,  //-10dB
    0.993231, -1.968805, 0.975837,  //-5dB
    1.000000, -1.975490, 0.975755,  //0dB
    1.006815, -1.982222, 0.975672,  //5dB
    1.012675, -1.988010, 0.975601,  //10dB
    1.017068, -1.992350, 0.975548,  //15dB
    1.020036, -1.995281, 0.975512}, //20dB
  //500Hz
  { 0.961560, -1.913552, 0.953018,
    0.967112, -1.918968, 0.952885,
    0.975420, -1.927074, 0.952686,
    0.986670, -1.938048, 0.952416,
    1.000000, -1.951052, 0.952097,
    1.013510, -1.964231, 0.951773,
    1.025199, -1.975634, 0.951493,
    1.034007, -1.984226, 0.951282,
    1.039977, -1.990050, 0.951139},
  //4kHz
  { 0.765220, -1.427897, 0.713047,
    0.796182, -1.452942, 0.708014,
    0.844255, -1.491829, 0.700199,
    0.912891, -1.547349, 0.689042,
    1.000000, -1.617811, 0.674882,
    1.095421, -1.694998, 0.659370,
    1.184476, -1.767035, 0.644893,
    1.255994, -1.824887, 0.633267,
    1.306813, -1.865994, 0.625006},
  //8kHz
  { 0.635135, -1.029868, 0.554054,
    0.680143, -1.058216, 0.541779,
    0.751804, -1.103350, 0.522235,
    0.858047, -1.170266, 0.493260,
    1.000000, -1.259673, 0.454545,
    1.165437, -1.363872, 0.409426,
    1.330134, -1.467604, 0.364509,
    1.470279, -1.555872, 0.326288,
    1.574468, -1.621494, 0.297872},
  //16000kHz
  { 0.512665, -0.458517, 0.404369,
    0.568797, -0.475532, 0.382266,
    0.660361, -0.503286, 0.346212,
    0.801307, -0.546010, 0.290712,
    1.000000, -0.606237, 0.212475,
    1.247961, -0.681399, 0.114837,
    1.514323, -0.762138, 0.009953,
    1.758097, -0.836031, -0.086036,
    1.950590, -0.894379, -0.161832} };

float a[FILTER_COUNT][(ORDER + 1) * 9] = {
  //250Hz
  { 1.000000, -1.956089, 0.956351,
    1.000000, -1.958914, 0.959176,
    1.000000, -1.963127, 0.963390,
    1.000000, -1.968805, 0.969068,
    1.000000, -1.975490, 0.975755,
    1.000000, -1.982222, 0.982487,
    1.000000, -1.988010, 0.988276,
    1.000000, -1.992350, 0.992616,
    1.000000, -1.995281, 0.995548},
  //500Hz
  { 1.000000, -1.913552, 0.914577,
    1.000000, -1.918968, 0.919996,
    1.000000, -1.927074, 0.928106,
    1.000000, -1.938048, 0.939086,
    1.000000, -1.951052, 0.952097,
    1.000000, -1.964231, 0.965283,
    1.000000, -1.975634, 0.976692,
    1.000000, -1.984226, 0.985289,
    1.000000, -1.990050, 0.991116},
  //4kHz
  { 1.000000, -1.427897, 0.478268,
    1.000000, -1.452942, 0.504196,
    1.000000, -1.491829, 0.544455,
    1.000000, -1.547349, 0.601933,
    1.000000, -1.617811, 0.674882,
    1.000000, -1.694998, 0.754791,
    1.000000, -1.767035, 0.829369,
    1.000000, -1.824887, 0.889262,
    1.000000, -1.865994, 0.931819},
  //8kHz
  { 1.000000, -1.029868, 0.189189,
    1.000000, -1.058216, 0.221922,
    1.000000, -1.103350, 0.274039,
    1.000000, -1.170266, 0.351307,
    1.000000, -1.259673, 0.454545,
    1.000000, -1.363872, 0.574864,
    1.000000, -1.467604, 0.694643,
    1.000000, -1.555872, 0.796566,
    1.000000, -1.621494, 0.872340},
  //16000kHz
  { 1.000000, -0.458517, -0.082966,
    1.000000, -0.475532, -0.048937,
    1.000000, -0.503286, 0.006573,
    1.000000, -0.546010, 0.092020,
    1.000000, -0.606237, 0.212475,
    1.000000, -0.681399, 0.362798,
    1.000000, -0.762138, 0.524277,
    1.000000, -0.836031, 0.672062,
    1.000000, -0.894379, 0.788758} };

void filter(void) {
    xn[0] = read_input();

    centre_tap[0] = xn[0] * b[0] [(gain[0] * 3)] +
    xnm1[0] * b[0] [(gain[0] * 3) + 1] +
    xnm2[0] * b[0] [(gain[0] * 3) + 2];

    xn[1] = centre_tap[0] * a[0] [(gain[0] * 3)] -
    ynm1[0] * a[0] [(gain[0] * 3) + 1] -
    ynm2[0] * a[0] [(gain[0] * 3) + 2];


    centre_tap [1] = xn[1] * b[1] [(gain[1] * 3)] +
    xnm1[1] * b[1] [(gain[1] * 3) + 1] +
    xnm2[1] * b[1] [(gain[1] * 3) + 2];

    xn[2] = centre_tap[1] * a [1] [(gain[1] * 3)] -
    ynm1[1] * a[1] [(gain[1] * 3) + 1] -
    ynm2[1] * a[1] [(gain[1] * 3) + 2];


    centre_tap[2] = xn[2] * b[2] [(gain[2] * 3)] +
    xnm1[2] * b[2] [(gain[2] * 3) + 1] +
    xnm2[2] * b[2] [(gain[2] * 3) + 2];

    xn[3] = centre_tap[2] * a[2] [(gain[2] * 3)] -
    ynm1[2] * a[2] [(gain[2] * 3) + 1] -
    ynm2[2] * a[2] [(gain[2] * 3) + 2];


    centre_tap [3] = xn [3] * b [3] [(gain[3] * 3)] +
    xnm1 [3] * b [3] [(gain[3] * 3) + 1] +
    xnm2 [3] * b [3] [(gain[3] * 3) + 2];

    xn[4] = centre_tap[3] * a[3] [(gain[3] * 3)] -
    ynm1[3] * a[3] [(gain[3] * 3) + 1] -
    ynm2[3] * a[3] [(gain[3] * 3) + 2];


    centre_tap[4] = xn[4] * b[4] [(gain[4] * 3)] +
    xnm1[4] * b[4] [(gain[4] * 3) + 1] +
    xnm2[4] * b[4] [(gain[4] * 3) + 2];

    xn[5] =  centre_tap[4] * a[4] [(gain[4] * 3)] -
    ynm1[4] * a[4] [(gain[4] * 3) + 1] -
    ynm2[4] * a[4] [(gain[4] * 3) + 2];
    
    if (DAC_SR_DMAUDR1){
      GPIOB->ODR &= ~(1 << 14);
    } else {
      GPIOB->ODR |= (1 << 14);
    }
    //sprintf(buf, "%f", xn[0]/4096);
    //send_usart_str(buf);
    //send_usart_str("\n\r");
    DAC->DHR8R1 = xn[5];  //output filters to DAC
    //DAC->DHR8R1 = 0b5555555555;
}
